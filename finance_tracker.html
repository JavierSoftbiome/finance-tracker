<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .container {
            max-width: 800px;
        }
        #risk-bar {
            height: 20px;
            border: 1px solid #ccc;
            transition: width 0.3s, background-color 0.3s;
        }
        .legend {
            margin-top: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Finance Tracker</h1>
        <p>Current ETH Price: <strong><span id="eth-price">Loading...</span></strong></p>
        <div class="row">
            <!-- Input Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="form-group">
                            <label for="debt">Debt (USD):</label>
                            <input type="number" id="debt" class="form-control" min="0" step="100" placeholder="Enter debt in USD">
                        </div>
                        <div class="form-group">
                            <label for="collateral">Collateral (ETH): <span id="collateral-usd">[Waiting for input/price]</span></label>
                            <input type="number" id="collateral" class="form-control" min="0" step="0.1" placeholder="Enter collateral in ETH">
                        </div>
                        <div class="form-group">
                            <label for="reserve-percent">Cash Reserve Percentage (%):</label>
                            <input type="number" id="reserve-percent" class="form-control" value="30" min="0" max="100" step="1">
                        </div>
                        <button id="calculate-btn" class="btn btn-primary">Calculate</button>
                    </div>
                </div>
            </div>
            <!-- Results Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h2>Results</h2>
                        <div id="results">
                            <p class="row">
                                <span class="col-8">Collateral Value:</span>
                                <span class="col-4 text-right" id="collateral-value-result">N/A USD</span>
                            </p>
                            <p class="row">
                                <span class="col-8">Debt-to-Collateral Ratio:</span>
                                <span class="col-4 text-right" id="ratio">N/A %</span>
                            </p>
                            <p class="row">
                                <span class="col-8">Liquidation Risk:</span>
                                <span class="col-4 text-right" id="liquidation-risk">N/A</span>
                            </p>
                            <p class="row">
                                <span class="col-8">Required Cash Reserve:</span>
                                <span class="col-4 text-right" id="cash-reserve">N/A USD</span>
                            </p>
                            <p class="row">
                                <span class="col-8">Risk Level:</span>
                                <span class="col-4 text-right" id="risk-level">N/A %</span>
                            </p>
                            <div id="risk-bar"></div>
                            <div class="legend">
                                <span style="color: #00FF00;">■</span> Low Risk (<70%)
                                <span style="color: #FFFF00;">■</span> Medium Risk (70-85%)
                                <span style="color: #FF0000;">■</span> High Risk (>85%)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let ethPrice = null;

        // Fetch ETH price from CoinGecko API
        async function fetchEthPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
                const data = await response.json();
                ethPrice = data.ethereum.usd;
                document.getElementById('eth-price').textContent = ethPrice.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
                updateCollateralUsd();
            } catch (error) {
                console.error('Error fetching ETH price:', error);
                document.getElementById('eth-price').textContent = 'Error';
            }
        }

        // Initial fetch and update every 60 seconds
        fetchEthPrice();
        setInterval(fetchEthPrice, 60000);

        // Update collateral USD value next to input box
        function updateCollateralUsd() {
            const collateral = parseFloat(document.getElementById('collateral').value);
            if (!isNaN(collateral) && ethPrice !== null) {
                const collateralValue = collateral * ethPrice;
                document.getElementById('collateral-usd').textContent = `${collateralValue.toLocaleString('en-US', { style: 'decimal', minimumFractionDigits: 0, maximumFractionDigits: 0 })} USD`;
            } else {
                document.getElementById('collateral-usd').textContent = 'N/A';
            }
        }

        // Listen for changes in collateral input
        document.getElementById('collateral').addEventListener('input', updateCollateralUsd);

        // Calculate button event listener
        document.getElementById('calculate-btn').addEventListener('click', () => {
            const debt = parseFloat(document.getElementById('debt').value);
            const collateral = parseFloat(document.getElementById('collateral').value);
            const reservePercent = parseFloat(document.getElementById('reserve-percent').value);

            // Check if inputs are valid
            if (isNaN(debt) || isNaN(collateral) || isNaN(reservePercent)) {
                alert('Please enter valid numbers in all fields.');
                return;
            }
            if (ethPrice === null) {
                alert('ETH price is not available. Please try again later.');
                return;
            }

            // Perform calculations
            const collateralValue = collateral * ethPrice;
            document.getElementById('collateral-value-result').textContent = `${collateralValue.toLocaleString('en-US', { style: 'decimal', minimumFractionDigits: 0, maximumFractionDigits: 0 })} USD`;

            if (collateral === 0) {
                document.getElementById('ratio').textContent = 'N/A %';
                document.getElementById('liquidation-risk').textContent = 'N/A';
                document.getElementById('cash-reserve').textContent = 'N/A USD';
                document.getElementById('risk-level').textContent = 'N/A %';
                const riskBar = document.getElementById('risk-bar');
                riskBar.style.width = '0%';
                riskBar.style.backgroundColor = 'grey';
                return;
            }

            const ratio = (debt / collateralValue) * 100;
            document.getElementById('ratio').textContent = `${ratio.toFixed(2)} %`;
            document.getElementById('risk-level').textContent = `${ratio.toFixed(2)} %`;

            // Liquidation risk calculation (liquidation at 90% collateral value)
            const liquidationPrice = debt / (0.9 * collateral);
            let liquidationRisk;
            if (ethPrice > liquidationPrice) {
                const dropAllowed = ((ethPrice - liquidationPrice) / ethPrice) * 100;
                liquidationRisk = `Safe until ETH drops by ${dropAllowed.toFixed(2)}% to $${liquidationPrice.toLocaleString('en-US', { style: 'decimal', minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            } else {
                liquidationRisk = 'Currently at risk of liquidation';
            }
            document.getElementById('liquidation-risk').textContent = liquidationRisk;

            const cashReserve = (reservePercent / 100) * collateral;
            document.getElementById('cash-reserve').textContent = `${cashReserve.toLocaleString('en-US', { style: 'decimal', minimumFractionDigits: 0, maximumFractionDigits: 0 })} USD`;

            // Update risk bar
            const riskBar = document.getElementById('risk-bar');
            const barWidth = Math.min(ratio, 100); // Cap at 100%
            riskBar.style.width = `${barWidth}%`;
            if (ratio < 70) {
                riskBar.style.backgroundColor = '#00FF00'; // Green
            } else if (ratio < 85) {
                riskBar.style.backgroundColor = '#FFFF00'; // Yellow
            } else {
                riskBar.style.backgroundColor = '#FF0000'; // Red
            }
        });
    </script>
</body>
</html>
