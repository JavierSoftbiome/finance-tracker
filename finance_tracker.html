<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Risk View</title>
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
  />
  <style>
    .container {
      max-width: 800px;
    }

    /* Make all .card borders semi-transparent black */
    .card {
      border: 1px solid rgba(0, 0, 0, 0.5) !important;
    }

    /* Risk bar container with a light border & default height of 10px */
    #risk-bar-container {
      width: 100%;
      height: 10px;
      border: 1px solid #eee; /* Lighter border color */
      background-color: #fff; /* White background so bar fill is visible */
      margin-top: 10px;       /* Spacing above the bar */
    }
    /* Inner bar that changes width & color based on risk */
    #risk-bar {
      height: 100%;
      width: 0;                 /* JS updates this dynamically */
      background-color: #00FF00;/* Default color, overwritten by JS logic */
      transition: width 1s;     /* Smooth width animation */
    }

    .legend {
      margin-top: 10px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <!-- Title & ETH Price Row with Left Padding -->
    <div class="row pl-2">
      <div class="col-12">
        <h1>Risk View</h1>
        <p>
          Current ETH Price:
          <strong><span id="eth-price">Loading...</span></strong>
        </p>
      </div>
    </div>

    <!-- Main row with align-items-stretch to match heights -->
    <div class="row align-items-stretch">
      <!-- LEFT COLUMN: Input Section -->
      <div class="col-md-6 d-flex">
        <div class="card flex-fill">
          <div class="card-body">
            <div class="form-group">
              <label for="debt">Debt (USD):</label>
              <input
                type="number"
                id="debt"
                class="form-control"
                min="0"
                step="100"
                placeholder="Enter debt in USD"
              />
            </div>
            <div class="form-group">
              <label for="collateral">Collateral (ETH):</label>
              <input
                type="number"
                id="collateral"
                class="form-control"
                min="0"
                step="0.1"
                placeholder="Enter collateral in ETH"
              />
            </div>
            <div class="form-group">
              <label for="reserve-percent">Cash Reserve Percentage (%):</label>
              <input
                type="number"
                id="reserve-percent"
                class="form-control"
                value="30"
                min="0"
                max="100"
                step="1"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Results Section -->
      <div class="col-md-6 d-flex">
        <div class="card flex-fill">
          <div class="card-body">
            <div id="results">
              <p class="row">
                <span class="col-8">Collateral Value:</span>
                <span class="col-4 text-right" id="collateral-value-result">N/A USD</span>
              </p>
              <p class="row">
                <span class="col-8">Liquidation Risk:</span>
                <span class="col-4 text-right" id="liquidation-risk">N/A</span>
              </p>
              <!-- ETH Price Limit Row (hidden by default) -->
              <p class="row" id="eth-price-limit-row" style="display: none;">
                <span class="col-8">ETH Price Limit:</span>
                <span class="col-4 text-right" id="eth-price-limit-value">N/A</span>
              </p>
              <p class="row">
                <span class="col-8">Recommended Cash Reserve:</span>
                <span class="col-4 text-right" id="cash-reserve">N/A USD</span>
              </p>

              <!-- Risk Bar Container -->
              <div class="row">
                <div class="col-12">
                  <div id="risk-bar-container">
                    <div id="risk-bar"></div>
                  </div>
                </div>
              </div>

              <div class="legend">
                <div><span style="color: #00FF00;">■</span> Low Risk (&lt;65%)</div>
                <div><span style="color: #FFD700;">■</span> Medium Risk (65-75%)</div>
                <div><span style="color: #FF0000;">■</span> High Risk (&gt;75%)</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /row -->
  </div><!-- /container -->

  <script>
    let ethPrice = null;

    // Fetch ETH price from CoinGecko API
    async function fetchEthPrice() {
      try {
        const response = await fetch(
          "https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd"
        );
        const data = await response.json();
        ethPrice = data.ethereum.usd;
        document.getElementById("eth-price").textContent = ethPrice.toLocaleString(
          "en-US",
          {
            style: "currency",
            currency: "USD",
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          }
        );
        calculate(); // Recalculate after updating ETH price
      } catch (error) {
        console.error("Error fetching ETH price:", error);
        document.getElementById("eth-price").textContent = "Error";
      }
    }

    // Load ETH price on page load
    fetchEthPrice();
    setInterval(fetchEthPrice, 60000); // Refresh every 60 seconds

    // Auto-calculation function
    function calculate() {
      const debt = parseFloat(document.getElementById("debt").value);
      const collateral = parseFloat(document.getElementById("collateral").value);
      const reservePercent = parseFloat(
        document.getElementById("reserve-percent").value
      );

      if (isNaN(debt) || isNaN(collateral) || isNaN(reservePercent)) {
        // If any field is empty or invalid, do nothing
        return;
      }

      if (ethPrice === null) {
        alert("ETH price is not available. Please try again later.");
        return;
      }

      // Collateral Value in USD
      const collateralValue = collateral * ethPrice;
      document.getElementById("collateral-value-result").textContent =
        isNaN(collateralValue)
          ? "N/A USD"
          : collateralValue.toLocaleString("en-US", {
              style: "decimal",
              minimumFractionDigits: 0,
              maximumFractionDigits: 0,
            }) + " USD";

      if (collateral === 0) {
        document.getElementById("liquidation-risk").textContent = "N/A";
        document.getElementById("eth-price-limit-row").style.display = "none";
        document.getElementById("cash-reserve").textContent = "N/A USD";
        const riskBar = document.getElementById("risk-bar");
        riskBar.style.width = "0%";
        riskBar.style.backgroundColor = "grey";
        return;
      }

      // Calculate ratio (used for risk bar color)
      const ratio = (debt / collateralValue) * 100;
      const riskBar = document.getElementById("risk-bar");
      const barWidth = Math.min(ratio, 100); // Cap at 100%
      riskBar.style.width = `${barWidth}%`;

      if (ratio < 65) {
        riskBar.style.backgroundColor = "#00FF00"; // Green
      } else if (ratio < 75) {
        riskBar.style.backgroundColor = "#FFD700"; // Yellow
      } else {
        riskBar.style.backgroundColor = "#FF0000"; // Red
      }

      // Calculate liquidation risk
      const liquidationPrice = debt / (0.9 * collateral);
      if (ethPrice > liquidationPrice) {
        const dropAllowed = ((ethPrice - liquidationPrice) / ethPrice) * 100;
        document.getElementById("liquidation-risk").textContent =
          dropAllowed.toFixed(2) + "%";

        // Show the "ETH Price Limit" row
        const limitValue = liquidationPrice.toLocaleString("en-US", {
          style: "decimal",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
        document.getElementById("eth-price-limit-row").style.display = "flex";
        document.getElementById("eth-price-limit-value").textContent =
          "$" + limitValue;
      } else {
        // Already at risk
        document.getElementById("liquidation-risk").textContent =
          "Currently at risk of liquidation";
        document.getElementById("eth-price-limit-row").style.display = "none";
      }

      // Recommended Cash Reserve
      const cashReserve = (reservePercent / 100) * debt;
      document.getElementById("cash-reserve").textContent =
        isNaN(cashReserve)
          ? "N/A USD"
          : cashReserve.toLocaleString("en-US", {
              style: "decimal",
              minimumFractionDigits: 0,
              maximumFractionDigits: 0,
            }) + " USD";
    }

    // Save input values to localStorage
    function saveInputs() {
      localStorage.setItem("debt", document.getElementById("debt").value);
      localStorage.setItem("collateral", document.getElementById("collateral").value);
      localStorage.setItem(
        "reservePercent",
        document.getElementById("reserve-percent").value
      );
    }

    // Load input values from localStorage and auto-calculate
    function loadInputs() {
      if (localStorage.getItem("debt")) {
        document.getElementById("debt").value = localStorage.getItem("debt");
      }
      if (localStorage.getItem("collateral")) {
        document.getElementById("collateral").value =
          localStorage.getItem("collateral");
      }
      if (localStorage.getItem("reservePercent")) {
        document.getElementById("reserve-percent").value =
          localStorage.getItem("reservePercent");
      }
      calculate();
    }

    // Attach event listeners to save inputs & recalc on changes
    document.getElementById("debt").addEventListener("input", () => {
      saveInputs();
      calculate();
    });
    document.getElementById("collateral").addEventListener("input", () => {
      saveInputs();
      calculate();
    });
    document.getElementById("reserve-percent").addEventListener("input", () => {
      saveInputs();
      calculate();
    });

    // Load stored values when the page loads
    window.addEventListener("load", loadInputs);
  </script>
</body>
</html>
