<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Finance Tracker</title>
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
  />
  <style>
    .container {
      max-width: 800px;
    }
    #risk-bar {
      height: 20px;
      border: 1px solid #ccc;
      transition: width 1s;
    }
    .legend {
      margin-top: 10px;
      font-size: 0.9em;
    }
    /* Pull the "Results" header up more */
    .card-body h2 {
      margin-top: -20px; /* Adjust as needed */
    }
    /* Optional: remove or reduce right padding for truly flush alignment */
    /* .card-body {
      padding-right: 0 !important;
    } */
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1>Finance Tracker</h1>
    <p>
      Current ETH Price:
      <strong><span id="eth-price">Loading...</span></strong>
    </p>
    <div class="row">
      <!-- Input Section -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <div class="form-group">
              <label for="debt">Debt (USD):</label>
              <input
                type="number"
                id="debt"
                class="form-control"
                min="0"
                step="100"
                placeholder="Enter debt in USD"
              />
            </div>
            <div class="form-group">
              <label for="collateral">
                Collateral (ETH):
                <span id="collateral-usd">[Waiting for input/price]</span>
              </label>
              <input
                type="number"
                id="collateral"
                class="form-control"
                min="0"
                step="0.1"
                placeholder="Enter collateral in ETH"
              />
            </div>
            <div class="form-group">
              <label for="reserve-percent">Cash Reserve Percentage (%):</label>
              <input
                type="number"
                id="reserve-percent"
                class="form-control"
                value="30"
                min="0"
                max="100"
                step="1"
              />
            </div>
            <!-- No "Calculate" button: auto-calculates -->
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h2>Results</h2>
            <div id="results">
              <p class="row">
                <span class="col-8">Collateral Value:</span>
                <span class="col-4 text-right pr-0" id="collateral-value-result">
                  N/A USD
                </span>
              </p>

              <!-- 1) Liquidation Risk Row (percentage or "Currently at risk") -->
              <p class="row">
                <span class="col-8">Liquidation Risk:</span>
                <span class="col-4 text-right pr-0" id="liquidation-risk">
                  N/A
                </span>
              </p>

              <!-- 2) ETH Price Limit Row (hidden by default, shows only if not currently at risk) -->
              <p class="row" id="eth-price-limit-row" style="display: none;">
                <span class="col-8">ETH Price Limit:</span>
                <span class="col-4 text-right pr-0" id="eth-price-limit-value">
                  N/A
                </span>
              </p>

              <p class="row">
                <span class="col-8">Required Cash Reserve:</span>
                <span class="col-4 text-right pr-0" id="cash-reserve">N/A USD</span>
              </p>

              <div id="risk-bar"></div>
              <div class="legend">
                <div><span style="color: #00FF00;">■</span> Low Risk (&lt;65%)</div>
                <div><span style="color: #FFD700;">■</span> Medium Risk (65-75%)</div>
                <div><span style="color: #FF0000;">■</span> High Risk (&gt;75%)</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let ethPrice = null;

    // Fetch ETH price from CoinGecko API
    async function fetchEthPrice() {
      try {
        const response = await fetch(
          "https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd"
        );
        const data = await response.json();
        ethPrice = data.ethereum.usd;
        document.getElementById("eth-price").textContent = ethPrice.toLocaleString(
          "en-US",
          {
            style: "currency",
            currency: "USD",
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          }
        );
        updateCollateralUsd();
        calculate(); // Recalculate after updating ETH price
      } catch (error) {
        console.error("Error fetching ETH price:", error);
        document.getElementById("eth-price").textContent = "Error";
      }
    }

    // Load ETH price on page load
    fetchEthPrice();
    setInterval(fetchEthPrice, 60000); // Refresh every 60 seconds

    // Update collateral USD value next to input box
    function updateCollateralUsd() {
      const collateral = parseFloat(document.getElementById("collateral").value);
      if (!isNaN(collateral) && ethPrice !== null) {
        const collateralValue = collateral * ethPrice;
        document.getElementById("collateral-usd").textContent =
          collateralValue.toLocaleString("en-US", {
            style: "decimal",
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          }) + " USD";
      } else {
        document.getElementById("collateral-usd").textContent = "N/A";
      }
    }

    // Auto-calculation function
    function calculate() {
      const debt = parseFloat(document.getElementById("debt").value);
      const collateral = parseFloat(document.getElementById("collateral").value);
      const reservePercent = parseFloat(
        document.getElementById("reserve-percent").value
      );

      if (isNaN(debt) || isNaN(collateral) || isNaN(reservePercent)) {
        // If any field is empty or invalid, do nothing
        return;
      }

      if (ethPrice === null) {
        alert("ETH price is not available. Please try again later.");
        return;
      }

      const collateralValue = collateral * ethPrice;
      document.getElementById("collateral-value-result").textContent =
        collateralValue.toLocaleString("en-US", {
          style: "decimal",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        }) + " USD";

      // If collateral is zero, reset fields
      if (collateral === 0) {
        document.getElementById("liquidation-risk").textContent = "N/A";
        document.getElementById("eth-price-limit-row").style.display = "none";
        document.getElementById("cash-reserve").textContent = "N/A USD";
        const riskBar = document.getElementById("risk-bar");
        riskBar.style.width = "0%";
        riskBar.style.backgroundColor = "grey";
        return;
      }

      // Calculate ratio (for risk bar color)
      const ratio = (debt / collateralValue) * 100;
      const riskBar = document.getElementById("risk-bar");
      const barWidth = Math.min(ratio, 100); // Cap at 100%
      riskBar.style.width = `${barWidth}%`;
      if (ratio < 65) {
        riskBar.style.backgroundColor = "#00FF00"; // Green
      } else if (ratio < 75) {
        riskBar.style.backgroundColor = "#FFD700"; // Yellow
      } else {
        riskBar.style.backgroundColor = "#FF0000"; // Red
      }

      // Liquidation risk calculations
      const liquidationPrice = debt / (0.9 * collateral);
      if (ethPrice > liquidationPrice) {
        // How much ETH can drop before liquidation
        const dropAllowed = ((ethPrice - liquidationPrice) / ethPrice) * 100;
        // 1) Set Liquidation Risk row to the percentage
        document.getElementById("liquidation-risk").textContent =
          dropAllowed.toFixed(2) + "%";

        // 2) Show "ETH Price Limit" row
        const limitValue = liquidationPrice.toLocaleString("en-US", {
          style: "decimal",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
        document.getElementById("eth-price-limit-row").style.display = "flex";
        document.getElementById("eth-price-limit-value").textContent =
          "$" + limitValue;
      } else {
        // If we are already at or below liquidation threshold
        document.getElementById("liquidation-risk").textContent =
          "Currently at risk of liquidation";
        // Hide "ETH Price Limit" row
        document.getElementById("eth-price-limit-row").style.display = "none";
      }

      // Required Cash Reserve
      const cashReserve = (reservePercent / 100) * debt;
      document.getElementById("cash-reserve").textContent =
        cashReserve.toLocaleString("en-US", {
          style: "decimal",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        }) + " USD";
    }

    // Save input values to localStorage
    function saveInputs() {
      localStorage.setItem("debt", document.getElementById("debt").value);
      localStorage.setItem("collateral", document.getElementById("collateral").value);
      localStorage.setItem(
        "reservePercent",
        document.getElementById("reserve-percent").value
      );
    }

    // Load input values from localStorage and auto-calculate
    function loadInputs() {
      if (localStorage.getItem("debt")) {
        document.getElementById("debt").value = localStorage.getItem("debt");
      }
      if (localStorage.getItem("collateral")) {
        document.getElementById("collateral").value =
          localStorage.getItem("collateral");
      }
      if (localStorage.getItem("reservePercent")) {
        document.getElementById("reserve-percent").value =
          localStorage.getItem("reservePercent");
      }
      calculate();
    }

    // Attach event listeners to save inputs & recalc on changes
    document.getElementById("debt").addEventListener("input", () => {
      saveInputs();
      calculate();
    });
    document.getElementById("collateral").addEventListener("input", () => {
      updateCollateralUsd();
      saveInputs();
      calculate();
    });
    document.getElementById("reserve-percent").addEventListener("input", () => {
      saveInputs();
      calculate();
    });

    // Load stored values when the page loads
    window.addEventListener("load", loadInputs);
  </script>
</body>
</html>
